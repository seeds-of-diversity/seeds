# Seeds of Diversity Seed Collection Manager templates

%% mycollStyle
<style>
.myc-form-section { border: 1px solid #ccc; border-radius:5px; padding:1em; text-align:center; }
.myc-where-form { width:100%; text-align:center; }
#myc-summary { border: 1px solid #ccc; border-radius:5px; padding:1em }
.myc-alloc-form-action { background-color:#ddd; margin:1em; padding:3px 2em; }
.myc-new-heading-cvname { font-size:150%; font-weight:bold }
</style>


%% mycollConsolePage_AddNewLot
<div id='consolePageStart' class='consolePage'>
    <div class='myc-form-section'>
        <h3>Identify the seeds</h3>
        <form>
        <div class='container-fluid'><div class='row'>
            <div class='col-md-6'>Enter the parent lot # <br/><input type='text' class='cpvar_parentlot' placeholder='Parent lot #'/></div>
            <div class='col-md-6'>Search for the variety name <br/>
                                  <select id='fk_sl_pcv' class='cpvar_fk_sl_pcv' style='width:40em'><option value='0'>Choose a cultivar</option></select>
            </div>
        </div></div>
        <input type='submit' value='Next'/>
        </form>
    </div>

    <script>
    $(document).ready(function () {
        let o = new SLPcvSelect2( { jSelect: $('#fk_sl_pcv'),
                                    qUrl: '[[var:qUrl]]' } );
    });
    </script>
</div>


<div id='consolePageOrigin' class='consolePage' style='display:none'>
# Vars:
# cpvar_heading     cultivar name generated from t_sname, t_pname, parentlot
# cpvar_t_sname     full species name
# cpvar_t_pname     pname
# cpvar_parentlot   parent lot # if defined

    <div class='myc-form-section'>
        <span class='cpvar_heading'></span><br/><hr/>
        
#        <span class='cpvar_t_pname'></span> <span class='cpvar_t_sname'></span><br/>
#        <span class='cpvar_parentlot'></span><br/>
#        <span class='cpvar_fk_sl_pcv'></span><br/>

        <form>
        <div style='text-align:center; margin:1.5em auto;width:100%'>
            <div class=''>Original name if different than the 'primary' cultivar name above</div>
            <div class=''>[[formtext:oname | size:40 class:cpvar_oname]]</div>

            <ul id='myc-where-header' class="nav nav-pills" style='display:inline-block; margin:2em auto'>
            <li data-where='homegrown' class="active"><a href="#">Homegrown seeds</a></li>
            <li data-where='purchased' class=''><a href="#">Purchased seeds</a></li>
            </ul>

            <div class='myc-where-form' id='homegrown' style=''>
                <div style='display:inline-block;text-align:right'>Grower and site&nbsp;&nbsp;<br/><br/>Year of harvest&nbsp;&nbsp;</div>
                <div style='display:inline-block;text-align:left'>[[formtext:supplier | size:40 class:cpvar_supplier]]<br/><br/>[[formtext:year | class:cpvar_year]]</div>
            </div>
            <div class='myc-where-form' id='purchased' style='display:none'>
                <div style='display:inline-block;text-align:right'>Company or supplier&nbsp;&nbsp;<br/><br/>Year of purchase [what does this mean]&nbsp;&nbsp;</div>
                <div style='display:inline-block;text-align:left'>[[formtext:supplier2 | size:40 class:cpvar_supplier2]]<br/><br/>[[formtext:year2 | class:cpvar_year2]]</div>
            </div>
        </div>
        <input type='submit' value='Next'/>
        </form>
    </div>
<script>
$(document).ready( function() {
    $('#consolePageOrigin #myc-where-header li a').click( function() {
        let jLI = $(this).closest('li');
        
        if(jLI) {
            $('#myc-where-header li').removeClass('active');
            jLI.addClass('active');
            
            let id = jLI.data('where');
            $('.myc-where-form').hide();
            $('#'+id).show();
        }
    })
    
});
</script>

</div>


<div id='consolePageAllocSeeds' class='consolePage' style='display:none'>
# Vars:
# cpvar_heading     cultivar name generated from t_sname, t_pname, parentlot
# cpvar_t_sname     full species name
# cpvar_t_pname     pname
# cpvar_parentlot   parent lot # if defined
# cpvar_oname       original name if specified
# cpvar_supplier    homegrown seeds: grower and site
# cpvar_year        homegrown seeds: year harvested
# cpvar_supplier2   purchased seeds: vendor 
# cpvar_year2       purchased seeds: year purchased
    <div class='myc-form-section'>
        <span class='cpvar_heading'></span><br/><hr/>

#    <h4 style='text-align:left'><span class='cpvar_t_sname'></span> : <span class='cpvar_t_pname'></span> (pcv <span class='cpvar_fk_sl_pcv'></span>) 
#        from <span class='cpvar_supplier'></span> <span class='cpvar_year'></span></h4>
    <div class='row' style='margin-top:1.5em'>
        <div class='col-md-4'>Total weight (g): [[formtext:gtotal | class:cpvar_gtotal]]<br/>
                              If you are doing a germination test, set those seeds aside first.</div>
        <div class='col-md-4'>100 seed weight (g): [[formtext:g100 | class:cpvar_g100]]</div>        
        <div class='col-md-4'>Seeds / population: [[formtext:pop | class:cpvar_pop]] <br/>(take germ % into account if known)</div>
    </div>

    <h3>Allocate the seeds</h3>
    <p></p>

    <div class='myc-infobox' style='border:1px #ccc solid; padding:1em'>
        <div class='container-fluid'>
            <div class='row'><div class='col-md-4'></div><div class='col-md-1'>location</div><div class='col-md-1'>pops</div><div class='col-md-1'>g</div><div class='col-md-1'>seeds</div></div>
            <div class='row'><div class='col-md-4' style='text-align:right'>Create lot (A)</div>
                             <div class='col-md-1'>[[formtext:loc0 |width:100%]]</div>
                             <div class='col-md-1'>[[formtext:pops0 |width:100%]]</div>
                             <div class='col-md-1'>[[formtext:g0 |width:100%]]</div>
                             <div class='col-md-1'>[[formtext:seeds0 |width:100%]]</div>
                             <div class='col-md-1'><strong><span id='allocseeds-result0'></span></strong></div>
            </div>
            <div class='row'><div class='col-md-4' style='text-align:right'>Create lot (B)</div>
                             <div class='col-md-1'>[[formtext:loc1 |width:100%]]</div>
                             <div class='col-md-1'>[[formtext:pops1 |width:100%]]</div>
                             <div class='col-md-1'>[[formtext:g1 |width:100%]]</div>
                             <div class='col-md-1'>[[formtext:seeds1 |width:100%]]</div>
                             <div class='col-md-1'><strong><span id='allocseeds-result1'></span></strong></div>
            </div>
            <div class='row'><div class='col-md-4' style='text-align:right'>Special</div>
                             <div class='col-md-1'></div>
                             <div class='col-md-1'>[[formtext:pops2 |width:100%]]</div>
                             <div class='col-md-1'>[[formtext:g2 |width:100%]]</div>
                             <div class='col-md-1'>[[formtext:seeds2 |width:100%]]</div>
                             <div class='col-md-1'><strong><span id='allocseeds-result2'></span></strong></div>
            </div>
            <div class='row'><div class='col-md-4' style='text-align:right'>Remainder</div>
                             <div class='col-md-1'></div>
                             <div class='col-md-1'>[[formtext:pops3 |width:100%]]</div>
                             <div class='col-md-1'>[[formtext:g3 |width:100%]]</div>
                             <div class='col-md-1'>[[formtext:seeds3 |width:100%]]</div>
                             <div class='col-md-1'><strong><span id='allocseeds-result3'></span></strong></div>
            </div>
            <div class='row'><div class='col-md-4' style='text-align:right'></div>
                             <div class='col-md-1'><button id='btnSave' class='btn btn-primary' disabled>Save</button></div>
            </div>
        </div>
    </div>
</div>
<script>
$(document).ready( function() {
    $(`#consolePageAllocSeeds .cpvar_gtotal, 
       #consolePageAllocSeeds .cpvar_g100, 
       #consolePageAllocSeeds .cpvar_pop`).on('blur', function() { AllocSeeds.CalcFromNewParms(''); });

    $(`#pops0, #pops1, #pops2, #pops3`    ).on('blur', function() { AllocSeeds.CalcFromNewParms('pops'); });
    $(`#g0, #g1, #g2, #g3`                ).on('blur', function() { AllocSeeds.CalcFromNewParms('g'); });
    $(`#seeds0, #seeds1, #seeds2, #seeds3`).on('blur', function() { AllocSeeds.CalcFromNewParms('seeds'); });
    $(`#loc0, #loc1`                      ).on('blur', function() { AllocSeeds.CalcFromNewParms(''); });        // just to enable/disable save button
});

class AllocSeeds
{
    static gtotal = 0;  // total grams
    static g100 = 0;    // weight of 100 seeds
    static pop = 0;     // seeds / population
    static alloc = {pops: [0.0, 0.0, 0.0, 0.0], g: [0.0, 0.0, 0.0, 0.0], seeds: [0, 0, 0, 0], loc: ['','']};  // g, pops, seeds for each row in the form

    static CalcFromNewParms( mode ) {
        this._getVals();

        if( !this.gtotal || !this.g100 || !this.pop ) return;

        // Blank mode means recalculate all lots based on change in governing parms. If no pops defined yet, set default and enter pops mode.
        if( mode == '' ) {
            mode = 'pops';
            if( !this.alloc.pops[0] && !this.alloc.pops[1] && !this.alloc.pops[2] ) { this.alloc.pops[0] = 10; }
        }

        switch(mode) {
        case 'pops':
            // recalc g and seeds
            this._setPop(0, this.alloc.pops[0]);
            this._setPop(1, this.alloc.pops[1]);
            this._setPop(2, this.alloc.pops[2]);
            break;
        case 'g':
            // recalc pops and seeds
            this._setG(0, this.alloc.g[0]);
            this._setG(1, this.alloc.g[1]);
            this._setG(2, this.alloc.g[2]);
            break;
        case 'seeds':
            // recalc pops and g
            this._setSeeds(0, this.alloc.seeds[0]);
            this._setSeeds(1, this.alloc.seeds[1]);
            this._setSeeds(2, this.alloc.seeds[2]);
            break;
        default:
        }

        // Always set row 3 (remaining) with whatever is not used in 0-2 ; if not enough seeds to satisfy rows 0-2 reduce quantities from top down
        let remaining = this.gtotal;
        for( let i = 0; i <= 2; ++i ) {
            if( this.alloc.g[i] > remaining )  this._setG(i, remaining);
            remaining = Math.max(remaining - this.alloc.g[i], 0);
        }
        this._setG(3, remaining);

        this._setVals();
        
        // can save if a pop is defined in rows 0 or 1, and a location is also defined wherever a pop is defined.
        // the extra ! coerce values to boolean so bitwise xor does the right thing
        let canSave = (this.alloc.pops[0] || this.alloc.pops[1]) && !(!this.alloc.pops[0] ^ !this.alloc.loc[0]) && !(!this.alloc.pops[1] ^ !this.alloc.loc[1]);
        if( canSave ) {
            $('#btnSave').removeAttr('disabled');
        } else {
            $('#btnSave').attr('disabled','disabled');
        }
    }

    static _setPop( i, pop )
    /***********************
        set form row i with calculated values based on given pop
     */
    {
        if( !pop ) {
            this.alloc.pops[i] = this.alloc.g[i] = this.alloc.seeds[i] = 0;
            return
        }
        
        this.alloc.pops[i] = pop;
        this.alloc.seeds[i] = pop * this.pop;
        this.alloc.g[i] = this.alloc.seeds[i] * this.g100 / 100;
    }

    static _setG( i, g )
    /*******************
        set form row i with calculated values based on given g
     */
    {
        if( !g ) {
            this.alloc.pops[i] = this.alloc.g[i] = this.alloc.seeds[i] = 0;
            return
        }

        this.alloc.g[i] = g;
        this.alloc.seeds[i] = g * 100 / this.g100;
        this.alloc.pops[i] = this.alloc.seeds[i] / this.pop;
    }

    static _setSeeds( i, seeds )
    /***************************
        set form row i with calculated values based on given number of seeds
     */
    {
        if( !seeds ) {
            this.alloc.pops[i] = this.alloc.g[i] = this.alloc.seeds[i] = 0;
            return
        }

        this.alloc.seeds[i] = seeds;
        this.alloc.g[i] = seeds * this.g100 / 100;
        this.alloc.pops[i] = seeds / this.pop;
    }

    static _getVals()
    {
        this.gtotal = parseFloat($('#consolePageAllocSeeds #gtotal').val()) || 0;
        this.g100   = parseFloat($('#consolePageAllocSeeds #g100').val()) || 0;
        this.pop    = parseFloat($('#consolePageAllocSeeds #pop').val()) || 0;

        this.alloc.loc[0] = $('#consolePageAllocSeeds #loc0').val();
        this.alloc.loc[1] = $('#consolePageAllocSeeds #loc1').val();

        for( let i = 0; i <= 3; ++i ) {
            this.alloc.pops[i] = parseFloat($('#consolePageAllocSeeds #pops'+i).val()) || 0;
            this.alloc.g[i] = parseFloat($('#consolePageAllocSeeds #g'+i).val()) || 0;
            this.alloc.seeds[i] = parseInt($('#consolePageAllocSeeds #seeds'+i).val()) || 0;    // don't allow fractional input because we show calc'd seeds as integers so e.g. 0.1 seeds would show >0 grams but 0 seeds
        }
    }
    
    static _setVals()
    {
        for( let i = 0; i <= 3; ++i ) {
            $('#consolePageAllocSeeds #pops'+i).val(Math.trunc(this.alloc.pops[i]*100)/100);    // to 2 digits but don't show training 0
            $('#consolePageAllocSeeds #g'+i).val(this.alloc.g[i].toFixed(2));                   // to 2 digits and always show trailing 0
            $('#consolePageAllocSeeds #seeds'+i).val(Math.trunc(this.alloc.seeds[i]));          // to integer
        }
    }
}
</script>

<div class='row' style='margin-top:2em'>
    <div class='col-md-8'>
        <div class='myc-alloc-form-action' data-action='remaining'>Put remaining seeds in location [[formtext:loc1 | size:6 class:myc-alloc-form-loc]] <button>Go</button></div>
        <div class='myc-alloc-form-action' data-action='lot'>Put [[formtext:quantity2 | class:myc_alloc_form_quantity]] seeds in location [[formtext:loc2 | size:6 class:myc-alloc-form-loc]] <button>Go</button></div>
        <div class='myc-alloc-form-action' data-action='germtest'>Reserve [[formtext:quantity3 | class:myc_alloc_form_quantity]] seeds for a germination test <button>Go</button></div>
    </div>
    <div class='col-md-4'>
        <div id='myc-summary'></div>
    </div>
</div>
</div>




%% AddAccessionHeading
<p class='head1'>You have <span class='cpvar_gtotal'></span> grams of <span class='cpvar_t_sname'></span> : <span class='cpvar_t_pname'></span> (pcv <span class='cpvar_fk_sl_pcv'></span>).</p>
<p class='head2'>100 seeds weigh <span class='cpvar_g100'></span> grams.<br/>
<span class='cpvar_pop'></span> seeds make a minimal population.<br/>
A population is <span class='cpvar_gpop'></span> grams.<br/>
</p> 

